---
title: "Domenech_Analysis"
author: "Charlie Wilson"
date: "June 2021"
output: pdf_document
editor_options: 
  chunk_output_type: inline
---

Setup and packages

```{r echo = T, results = 'hide'}

#Additional packages:
library(ggplot2) 
library(ggpubr)
library(tidyr) 
library(dplyr) 
library(lubridate) 
library(svDialogs)
library(RcppRoll)

```

Function for plot DFs

```{r echo = T, results = 'hide'}
## Gives count, mean, standard deviation, standard error of the mean, and confidence interval (default 95%).
##   data: a data frame.
##   measurevar: the name of a column that contains the variable to be summariezed
##   groupvars: a vector containing names of columns that contain grouping variables
##   na.rm: a boolean that indicates whether to ignore NA's
##   conf.interval: the percent range of the confidence interval (default is 95%)
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
  
    # New version of length which can handle NA's: if na.rm==T, don't count them
    length2 <- function (x, na.rm=FALSE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }

    # This does the summary. For each group's data frame, return a vector with
    # N, mean, and sd
    datac <- ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col) {
        c(N    = length2(xx[[col]], na.rm=na.rm),
          mean = mean   (xx[[col]], na.rm=na.rm),
          sd   = sd     (xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )

    # Rename the "mean" column    
    datac <- rename(datac, c("mean" = measurevar))

    datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean

    # Confidence interval multiplier for standard error
    # Calculate t-statistic for confidence interval: 
    # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult

    return(datac)
}
```

Setup and count and order data
Then extract it if needed
Skip to next chunk if already saved

```{r}

monkey <- dlgInput("Enter monkey", Sys.info()["user"])$res

# Where are the data?
##For Charlie Macbook
path <- file.path("/Users/charliewilson/Dropbox/Reversible Cognition/Domenech_Analysis/",monkey); #Where are the data? You need to change this for your data location
save.path <- file.path("/Users/charliewilson/Dropbox/Reversible Cognition/Domenech_Analysis"); #Path to save your data frame. Try not to put it in with the raw data

#List and organise the data
Session.list <- dir(path = path, pattern = "*.txt"); #List the files in the date
Dates <- data.frame(Session.list); #Extract dates from filenames

colnames(Dates) <- c("fid"); #rename File ID column
Dates <- Dates %>% separate(fid, c("Monkey", "Date","_","Time","Ext"),sep=cumsum(c(2,6,1,4,4))); #Split the filename into separate sections
Dates$Date <- dmy(Dates$Date); #Put Date column into date format
Dates$fid <- Session.list; 
Dates <- arrange(Dates, Date); #Put Dates into date order

Nsession <- length(Dates$Date); # How many sessions?

Data <- data.frame(); #Initialise big data frame

if(Nsession >0){ #Sanity check
  
    for(isession in 1:Nsession){ #Loop on each session  
      
      fid <- Dates$fid[isession]; #Extract filename from Dates
      print(fid) #Show filename
      event.raw <- read.csv(file=paste(path,"/",fid, sep= ""),sep= "", dec =",",  header = FALSE, fill=TRUE, colClasses=c(NA, NA,"NULL")); #Load data from .txt file using space as separator
      colnames(event.raw) <- c("time","event"); #Name columns
      event.raw$session <- isession; #Record session number
      
      # Now some basic analysis
      event.raw$trial <- cumsum(event.raw$event == 100); #Trial number
      
      # Which stimulus was used in the trial
      event.raw <- event.raw %>%
        group_by(trial) %>%   #Apply this trial by trial (rather than line by line)
        dplyr:: mutate(Stim = nth(event,4)) %>%  #In every trial take teh nth entry in the Event column
        ungroup();  #Put it back with the new column
      
      # Which TS
      event.raw <- event.raw %>%
        group_by(trial) %>%
        dplyr:: mutate(TS = nth(event,2)) %>%
        ungroup();
      
      # This is the end of intiial analysis of a single day
      
      #Put this session (event.raw) into Data which will contain all of the sessions
      Data <- rbind(Data,event.raw);
      
     rm(event.raw)
        
    }
  }

#Save
save(file = paste(save.path,"/Data_Domenech_",monkey,".Rdata",sep = ""),Data, Dates) # Save monkey specific data frame

``` 

 If you don't need to run all of the above because you have already done it, you can load the data like this:
 
```{r}

monkey <- dlgInput("Enter monkey", Sys.info()["user"])$res

# Where are the data?
save.path <- file.path("/Users/charliewilson/Dropbox/Reversible Cognition/Domenech_Analysis"); #Path to save your data frame. Try not to put it in with the raw data

load(file = paste(save.path,"/Data_Domenech_",monkey,".Rdata",sep = ""))
```


What is in each session?
 
  
```{r}
 

# Need to count the 150-153 and then look at traps as a % of this. That sets us the number of trials with an outcome

#How many traps?
Sess.data <- Data %>%
        group_by(session) %>%   #Apply this session by session
        filter(event==152) %>%   #Noisy good answer
        count(event)  #Count the instances
Sess.data2 <- Data %>%
        group_by(session) %>%   #Apply this session by session
        filter(event==153) %>%   #Noisy bad answer
        count(event)  #Count the instances
Sess.data3 <- Data %>%
        group_by(session) %>%   #Apply this session by session
        filter(event==65) %>%   #Rewards
        count(event)  #Count the instances
Sess.dat <- merge(Sess.data, Sess.data2, by="session") %>%
              merge(Sess.data3, by="session") # Combine the DFs and make sure it is done on the basis of "session"

colnames(Sess.dat) <- c("session","xx","Noiseg","yy","Noiseb","zz","Rew"); #Rename columns
Sess.dat <- subset(Sess.dat, select= -c(xx,yy,zz)); #remove superfluous columns
remove(Sess.data, Sess.data2,Sess.data3); #remove superfluous DFs

ggplot(Sess.dat, aes(x=session)) + #What data to plot
    geom_point(aes(y=Noiseg),color='red') + #Add a specific plot and colour it
    geom_point(aes(y=Noiseb),color='blue') +
    geom_point(aes(y=Rew),color='green') 

```

Let's build a trial by trial matrix to help the trial analysis

```{r}

# First some summary statistics from the whole trial
Data <- Data %>%
  dplyr::group_by(session,trial) %>%
  dplyr::mutate(GNorm = sum(event == 150), BNorm = sum(event == 151),GTrap = sum(event == 152), BTrap = sum(event == 153), Rew = sum(event == 65)) %>%
  dplyr::ungroup() 

# And use that to extract if the response was correct or not
Data <- Data %>%
  dplyr::group_by(session,trial) %>%
  dplyr::mutate(COR = max(GNorm | GTrap), INC = max(BNorm | BTrap)) %>%
  dplyr::ungroup() 

# Extract response
Data <- Data %>%
  dplyr::group_by(session,trial) %>%
  dplyr::mutate(Resp = 
                  case_when(
                    sum(event == 61)>0 ~ 1,
                    sum(event == 62)>0 ~ 2,
                    sum(event == 63)>0 ~ 3)) %>%
  dplyr::ungroup() 

# Now extract the first line of each trial
rm ('Trials')
Trials <- Data %>%
  dplyr::group_by(session, trial) %>%
  slice(1)
Trials <- subset(Trials, COR>0 | INC>0) # Just trials with an outcome

# Extract the previous trial info for Stim and Rew
Trials <- Trials %>%
  dplyr::group_by(session) %>%
  dplyr::mutate(PrevSt=lag(Stim), PrevOut=lag(COR) ) %>%
  dplyr::ungroup() 

# How many rewards in the last 3 trials?
Trials <- Trials %>%
  dplyr::group_by(session) %>%
  dplyr::mutate(roll_sum = roll_sum(Rew, 4, align = "right", fill = NA)) %>%
  dplyr::ungroup() 
   
# We want a new DF with the outcomes around each trap
TrapI <- which(Trials$GTrap == 1 | Trials$BTrap == 1)

# Count trials since and to the Gtraps
Trials$GTrapCyc = cumsum(Trials$GTrap)
Trials <- Trials %>%
  group_by(GTrapCyc) %>% 
  dplyr::mutate(GTrapC = row_number()-1,GTrapCback = row_number() - (n()+1))

# Subset down to trials just around Traps and set t around Traps
rm ('Traps', 'TrapSE')
Traps <- subset(Trials, GTrapC <=2 | GTrapCback == -1)
Traps$t <-Traps$GTrapC
Traps$t[Traps$t>2] <- -1

# Is the response the same as the Trap?
Traps <- Traps %>%
  group_by(GTrapCyc) %>% 
  dplyr::mutate(TrapR = dplyr::first(Resp), SameRT = as.integer(TrapR==Resp)) 

# Is the stimulus the same as the Trap?
Traps <- Traps %>%
  group_by(GTrapCyc) %>% 
  dplyr::mutate(TrapS = dplyr::first(Stim), SameST = as.integer(TrapS==Stim))

TrapSSame <- subset(Traps, SameST == 1)
TrapSDif <- subset(Traps, SameST == 0)

# summarySE provides the standard deviation, standard error of the mean, and a (default 95%) confidence interval
# We need the summary for teh different t values -1 to 2
# But for t=2 only we need to split on the basis of PrevOut 
# The following is an ugly way of achieving this...
SS1 <- summarySE(TrapSSame, measurevar="SameRT", groupvars=c("t","PrevOut"))
SS1 <- subset(SS1, t==2 & !is.na(PrevOut),select=-PrevOut)
SS2 <- summarySE(TrapSSame, measurevar="SameRT", groupvars=c("t"))
SS2 <- subset(SS2, t<2 & t!=0)
SumSame <- rbind(SS2,SS1)

# Also for the Different stimulus...
SD1 <- summarySE(TrapSDif, measurevar="SameRT", groupvars=c("t","PrevOut"))
SD1 <- subset(SD1, t==2 & !is.na(PrevOut),select=-PrevOut)
SD2 <- summarySE(TrapSDif, measurevar="SameRT", groupvars=c("t"))
SD2 <- subset(SD2, t<2)
SumDif <- rbind(SD2,SD1)

# Reproduce figs 2a,b from the Domenech Manuscript
xxx <- c("t1-","t1+")

ggplot(SumSame, aes(x=t,y=SameRT)) + #What data to plot
    geom_point(size=3,color='red',fill='white')+
    geom_text(aes(label=ifelse(t>1,xxx,'')),hjust=2,vjust=-1) +
    geom_errorbar(aes(ymin=SameRT-se, ymax=SameRT+se), width=.1) +
    ylim(0,1) +
    geom_hline(aes(yintercept=0.333), colour="#990000", linetype="dashed") +
    geom_rect(aes(xmin=-0.1, xmax=0.1, ymin=0, ymax=1), color="grey", alpha=0.1) +
    ggtitle("Same Stimulus as 'Negative' Trap on t0") +
    theme(plot.title = element_text(hjust = 0.5)) +
    ylab("Proportion repetition same respons as 'Neg' Trap") +
    xlab("Trials since 'Neg' Trap")
   
ggplot(SumDif, aes(x=t,y=SameRT)) + #What data to plot
    geom_point(size=3,color='blue',fill='white')+
    geom_text(aes(label=ifelse(t>1,xxx,'')),hjust=2,vjust=-1) +
    geom_errorbar(aes(ymin=SameRT-se, ymax=SameRT+se), width=.1) +
    ylim(0,1) +
    geom_hline(aes(yintercept=0.333), colour="#990000", linetype="dashed") +
    geom_rect(aes(xmin=-0.1, xmax=0.1, ymin=0, ymax=1), color="grey", alpha=0.1) +
    ggtitle("Different Stimulus from 'Negative' Trap on t0") +
    theme(plot.title = element_text(hjust = 0.5)) +
    ylab("Proportion repetition same respons as 'Neg' Trap") +
    xlab("Trials since 'Neg' Trap")
  


# Reproduce figs 2c,d from the Domenech Manuscript

t1same <- subset(TrapSSame,t==1)
Sumt1same <- summarySE(t1same, measurevar="SameRT", groupvars=c("roll_sum"))
t1dif <- subset(TrapSDif,t==1)
Sumt1dif <- summarySE(t1dif, measurevar="SameRT", groupvars=c("roll_sum"))

ggplot(Sumt1same, aes(x=roll_sum,y=SameRT)) + #What data to plot
  geom_point()+
  geom_line(color='red')+
  geom_errorbar(aes(ymin=SameRT-se, ymax=SameRT+se), width=.1) +
    ylim(0,1) +
    geom_hline(aes(yintercept=0.333), colour="#990000", linetype="dashed") +
    ggtitle("Same Stimulus as 'Negative' Trap on t0") +
    theme(plot.title = element_text(hjust = 0.5)) +
    ylab("Proportion repetition same response on t1 as 'Neg' Trap") +
    xlab("# Rewards in 3 trials before 'Neg' Trap")

ggplot(Sumt1dif, aes(x=roll_sum,y=SameRT)) + #What data to plot
  geom_point()+
  geom_line(color='blue') +
  geom_errorbar(aes(ymin=SameRT-se, ymax=SameRT+se), width=.1) +
    ylim(0,1) +
    geom_hline(aes(yintercept=0.333), colour="#990000", linetype="dashed") +
    ggtitle("Different Stimulus from 'Negative' Trap on t0") +
    theme(plot.title = element_text(hjust = 0.5)) +
    ylab("Proportion repetition same response on t1 as 'Neg' Trap") +
    xlab("# Rewards in 3 trials before 'Neg' Trap")
```


*Deprecated code from Iris project*

Let's plot something simple
 
```{r}

# First we summarise the data in a number of sessions
# Let's count the codes 65 and 100 (reward and trials)
# To help you learn we do this in 2 different data frames and then combine them
# It is also possible to do this in one go...

Sess.data <- Data %>%
        group_by(session) %>%   #Apply this session by session
        filter(event==65) %>%   #Only look at 65  
        count(event)  #Count teh instances

Sess.data2 <- Data %>%
        group_by(session) %>%   #Apply this session by session
        filter(event==100) %>%   #Only look at 100  
        count(event)  #Count the instances

Sess.dat <- left_join(Sess.data, Sess.data2, by="session") # Combine teh two DFs and make sure it is done on the basis of "session"
colnames(Sess.dat) <- c("session","xx","Rew","yy","Trials"); #Rename columns
Sess.dat <- subset(Sess.dat, select= -c(xx,yy)); #remove superfluous columns
remove(Sess.data, Sess.data2); #remove superfluous DFs


ggplot(Sess.dat, aes(x=session)) + #What data to plot
    geom_point(aes(y=Rew),color='red') + #Add a specific plot and colour it
  geom_point(aes(y=Trials),color='blue') #Add a specific plot and colour it

#Now add a calculation to the DF

Sess.dat$Rate <- Sess.dat$Trials/Sess.dat$Rew #How many trials per reward

# Now plot that

ggplot(Sess.dat, aes(x=session, y=Rate)) + #What data to plot
    geom_point(color='red') + #Add a specific plot and colour it
    geom_smooth() #Add a smoothed line

```

 Ok, where are the pauses
 
 
Let's plot something simple
 
 
```{r}

Time <- subset(Data, event==75)
Time <- Time %>%  
  mutate(diff_row = time - lag(time))
Time$diff_row <- replace(Time$diff_row, which(Time$diff_row < 0), NA)

ggplot(Time, aes(x=diff_row)) + geom_histogram(binwidth=500) + xlim(0, 20000)
ggplot(Time, aes(x=diff_row)) + geom_histogram(binwidth=10000) + xlim(20000,max(Time$diff_row)) 
ggplot(Time, aes(x=diff_row)) + geom_histogram(binwidth=10000) + xlim(20000,300000) 
ggplot(Time, aes(x=diff_row)) + geom_histogram(binwidth=5000) + scale_y_log10()


Pauses <- subset(Time, diff_row>120000)
ggplot(Pauses, aes(x=time)) + geom_density()
ggplot(Pauses, aes(x=time)) + geom_histogram(binwidth=100000)
ggplot(Pauses, aes(x=trial)) + geom_density()
ggplot(Pauses, aes(x=trial)) + geom_histogram(binwidth=10)
```
 
 Iris Pause Extcraction
```{r}


#filtrer les donn?es pour ne conserver qu'un seul ?v?nement
DataEvent <- dplyr::filter(Data,event == 75)

#cr?ation d'une nouvelle colone en d?calant => utiliser fct "lag", default pour le d?calage
DataEvent<-dplyr::mutate(DataEvent, time2 = lag(time, default=0))
#supprimer les colones inutiles (=garder les colones utiles)
DataEvent<-dplyr::select(DataEvent, session, trial, event, time, time2)
#temps entre chaque ?v?nement
DataEvent<-dplyr::mutate(DataEvent, ecart=time-time2)
#enl?ve les ?carts qui ne correspondent pas ? des pauses (d'une session ? l'autre)
DataEvent<-dplyr::filter(DataEvent, ecart>0)

#graphiques pour d?terminer ce qu'on consid?re comme une pause (? revoir en fct des r?sutats)
ggplot(DataEvent, aes(x=ecart)) + geom_histogram(binwidth = 1000)
# pour plus tard x, y, alpha, color, fill, linetype, size, weight
# xlim + scale_y_log10()

#s?parer le graphique en 2 parties pour voir o? d?marrent les pauses
ggplot(DataEvent, aes(x=ecart)) + geom_histogram(binwidth = 500) + xlim(0,40000)
ggplot(DataEvent, aes(x=ecart)) + geom_histogram(binwidth = 1000) + xlim(40000,1000000)

ggplot(DataEvent, aes(x=ecart)) + geom_density() + xlim(0,40000)
ggplot(DataEvent, aes(x=ecart)) + geom_density() + xlim(40000,1000000)

#ok maintenant on a d?termin? la pause => quand dans la session
DataPause<-dplyr::filter(DataEvent,ecart>120000)
#save(file = paste(save.path,"/Data_Iris_Pauses_",monkey,".Rdata",sep = ""),DataPause)
save(file = paste("Data_Iris_Pauses_",monkey,".Rdata",sep = ""),DataPause)
#graphique pause
ggplot(DataPause, aes(x=time)) + geom_histogram()
ggplot(DataPause, aes(x=time)) + geom_density()


#on veut voir la relation entre un ?v?nement (les pauses) et un autre
DataEvent2 <- dplyr::filter(Data,event == 101)

 
```
 

 
Some simple analysis around the pauses

 
```{r}

#------comparer le nombre de switch (78) par rapport au nombre de pauses------

Nb.Sess1 <-Data %>% group_by(session) %>% filter(event==78) %>% count(event)
Nb.Sess2 <- DataPause %>%group_by(session) %>% filter(event==75) %>% count(event)
Nb.Switch <- left_join(Nb.Sess1, Nb.Sess2, by="session")
colnames(Nb.Switch) <- c("session","code Switch","Switch","code Pauses","Pauses");
  # pas besoin : Nb.sess <- subset(Nb.sess, select= -c(xx,yy));
remove(Nb.Sess1, Nb.Sess2)

ggplot(Nb.Switch, aes(x=session)) + 
  geom_point(aes(y=Switch),color='blue') + geom_point(aes(y=Pauses),color='black')

Nb.Switch$rapport <- Nb.Switch$Pauses/Nb.Switch$Switch

ggplot(Nb.Switch, aes(x=session, y=rapport)) +
  geom_point(color='blue') + geom_smooth(color='blue')

ggplot(Nb.Switch, aes(x=Pauses, y=Switch)) + 
  geom_point(color='blue')

#-------comparer le nombre de r?compenses (65) par rapport au nombre de pauses---------

Nb.Sess1 <-Data %>% group_by(session) %>% filter(event==65) %>% count(event)
Nb.Sess2 <- DataPause %>%group_by(session) %>% filter(event==75) %>% count(event)
Nb.Reward <- left_join(Nb.Sess1, Nb.Sess2, by="session")
colnames(Nb.Reward) <- c("session","code Reward","Reward","code Pauses","Pauses");
# pas besoin : Nb.sess <- subset(Nb.sess, select= -c(xx,yy));
remove(Nb.Sess1, Nb.Sess2)

ggplot(Nb.Reward, aes(x=session)) + 
  geom_point(aes(y=Reward),color='orange') + geom_point(aes(y=Pauses),color='black')

Nb.Reward$rapport <- Nb.Reward$Pauses/Nb.Reward$Reward

ggplot(Nb.Reward, aes(x=session, y=rapport)) +
  geom_point(color='orange') + geom_smooth(color='orange')

ggscatter(Nb.Reward, x = "Pauses", y = "Reward",
          add = "reg.line",                                 # Add regression line
          conf.int = TRUE,                                  # Add confidence interval
          add.params = list(color = "orange",
                            fill = "lightgray")
          )+
  stat_cor(method = "pearson", label.x = 3, label.y = 30)  # Add correlation coefficient

#-------comparer le nombre de t?che complet?e (103) par rapport au nombre de pauses---------

Nb.Sess1 <-Data %>% group_by(session) %>% filter(event==103) %>% count(event)
Nb.Sess2 <- DataPause %>%group_by(session) %>% filter(event==75) %>% count(event)
Nb.Complet <- left_join(Nb.Sess1, Nb.Sess2, by="session")
colnames(Nb.Complet) <- c("session","code Complet","Complet","code Pauses","Pauses");
# pas besoin : Nb.sess <- subset(Nb.sess, select= -c(xx,yy)); #remove superfluous columns
remove(Nb.Sess1, Nb.Sess2)

ggplot(Nb.Complet, aes(x=session)) + 
  geom_point(aes(y=Complet),color='pink') + geom_point(aes(y=Pauses),color='black')

Nb.Complet$rapport <- Nb.Complet$Pauses/Nb.Complet$Complet

ggplot(Nb.Complet, aes(x=session, y=rapport)) +
  geom_point(color='pink') + geom_smooth(color='pink')


ggscatter(Nb.Complet, x = "Pauses", y = "Complet",
          add = "reg.line",                                 # Add regression line
          conf.int = TRUE,                                  # Add confidence interval
          add.params = list(color = "pink",
                            fill = "lightgray")
          )+
  stat_cor(method = "pearson", label.x = 3, label.y = 30)  # Add correlation coefficient


#-------comparer le nombre d'incorrect (69) par rapport au nombre de pauses---------

Nb.Sess1 <-Data %>% group_by(session) %>% filter(event==69) %>% count(event)
Nb.Sess2 <- DataPause %>%group_by(session) %>% filter(event==75) %>% count(event)
Nb.Neg <- left_join(Nb.Sess1, Nb.Sess2, by="session")
colnames(Nb.Neg) <- c("session","code Erreur","Erreur","code Pauses","Pauses");
# pas besoin : Nb.sess <- subset(Nb.sess, select= -c(xx,yy)); #remove superfluous columns
remove(Nb.Sess1, Nb.Sess2)

ggplot(Nb.Neg, aes(x=session)) + 
  geom_point(aes(y=Erreur),color='red') + geom_point(aes(y=Pauses),color='black')

Nb.Neg$rapport <- Nb.Neg$Pauses/Nb.Neg$Erreur

ggplot(Nb.Neg, aes(x=session, y=rapport)) +
  geom_point(color='red') + geom_smooth(color='red')

 
ggscatter(Nb.Neg, x = "Pauses", y = "Erreur",
          add = "reg.line",                                 # Add regression line
          conf.int = TRUE,                                  # Add confidence interval
          add.params = list(color = "red",
                            fill = "lightgray")
          )+
  stat_cor(method = "pearson", label.x = 3, label.y = 30)  # Add correlation coefficient


#-------comparer le nombre de fb positifs (68) par rapport au nombre de pauses---------

Nb.Sess1 <-Data %>% group_by(session) %>% filter(event==68) %>% count(event)
Nb.Sess2 <- DataPause %>%group_by(session) %>% filter(event==75) %>% count(event)
Nb.Pos <- left_join(Nb.Sess1, Nb.Sess2, by="session")
colnames(Nb.Pos) <- c("session","code FB positif","FB.positif","code Pauses","Pauses");
# pas besoin : Nb.sess <- subset(Nb.sess, select= -c(xx,yy)); #remove superfluous columns
remove(Nb.Sess1, Nb.Sess2)

ggplot(Nb.Pos, aes(x=session)) + 
  geom_point(aes(y=FB.positif),color='red') + geom_point(aes(y=Pauses),color='black')

Nb.Pos$rapport <- Nb.Pos$Pauses/Nb.Pos$FB.positif

ggplot(Nb.Pos, aes(x=session, y=rapport)) +
  geom_point(color='green') + geom_smooth(color='green')
 

ggscatter(Nb.Pos, x = "Pauses", y = "FB.positif",
          add = "reg.line",                                 # Add regression line
          conf.int = TRUE,                                  # Add confidence interval
          add.params = list(color = "green",
                            fill = "lightgray")
          )+
  stat_cor(method = "pearson", label.x = 3, label.y = 30)  # Add correlation coefficient

```
 
 What happened just before the pauses?
 
```{r} 
 

NPause<-length(DataPause$session)
Nbuffer <- 20
counts <- data.frame(matrix(ncol = 5, nrow = NPause)) #Dataframe to collect teh new data
colnames(counts) <- c("inc","cor","rew","sw","comp"); #rename File ID column

for(iDataPause in 1:NPause){   #Boucle sur chaque pause
  
  # Extraction de coordonnées de la pause pour le trouver dans Data
  x <- DataPause$session[iDataPause]; 
  y <- DataPause$trial[iDataPause];
  
  #Extraction des Nbuffer dernier essaies avant la pause
  test<- Data %>%
    filter( session==x, between(trial,y-Nbuffer,y))
  
  # Compte les differents codes dasn test et appliquer à DataPause
 counts$inc[iDataPause] <- test %>%
        tally(event==69)  #Count the number of that code  
 counts$cor[iDataPause] <- test %>%
        tally(event==68)  #Count the number of that code  
 counts$rew[iDataPause] <- test %>%
        tally(event==65)  #Count the number of that code  
 counts$sw[iDataPause] <- test %>%
        tally(event==78)  #Count the number of that code  
 counts$comp[iDataPause] <- test %>%
        tally(event==103)  #Count the number of that code  
  
 rm(test) #Clean up
 # print(iDataPause) # Option pour checker le boucle
}
 
# rentre counts dans DataPause
 DataPause <- cbind(DataPause, counts)
 
 # Le output du "count" est un "discrete". Il faut le rendre numerique pour plotter
 DataPause$inc <- as.numeric(as.character(DataPause$inc))
  DataPause$cor <- as.numeric(as.character(DataPause$cor))
   DataPause$rew <- as.numeric(as.character(DataPause$rew))
    DataPause$sw <- as.numeric(as.character(DataPause$sw))
     DataPause$comp <- as.numeric(as.character(DataPause$comp))

 # Exemple figure compare ecart et time
 
 ggscatter(DataPause, x = "inc", y = "ecart",
          add = "reg.line",                                 # Add regression line
          conf.int = TRUE,                                  # Add confidence interval
          add.params = list(color = "red",
                            fill = "lightgray")
          )+
  stat_cor(method = "pearson", label.x = 3, label.y = 30)  # Add correlation coefficient
  
# Exemple figure compare inc et time
 
 ggscatter(DataPause, x = "inc", y = "time",
          add = "reg.line",                                 # Add regression line
          conf.int = TRUE,                                  # Add confidence interval
          add.params = list(color = "green",
                            fill = "lightgray")
          )+
  stat_cor(method = "pearson", label.x = 3, label.y = 30)  # Add correlation coefficient
 
 
```




 
 